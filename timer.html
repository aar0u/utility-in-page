<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Timer</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <div class="container">
      <h1>Timer</h1>
      <div class="input-group">
        <div class="time-inputs">
          <div class="time-input-wrapper">
            <label for="countdown-minutes">Min</label>
            <input
              type="number"
              id="countdown-minutes"
              name="countdown-minutes"
              min="0"
              max="60"
              step="1"
              value="25"
              data-default="25"
            />
          </div>
          <span class="time-separator">:</span>
          <div class="time-input-wrapper">
            <label for="countdown-seconds">Sec</label>
            <input
              type="number"
              id="countdown-seconds"
              name="countdown-seconds"
              min="0"
              max="59"
              step="1"
              value="0"
              data-default="0"
            />
          </div>
        </div>
      </div>

      <div class="quick-select">
        <button class="quick-btn" data-minutes="5" data-seconds="0">5 min</button>
        <button class="quick-btn" data-minutes="25" data-seconds="0">25 min</button>
        <button class="quick-btn" data-minutes="0" data-seconds="30">30 sec</button>
        <button class="quick-btn" data-minutes="1" data-seconds="0">1 min</button>
      </div>

      <div class="timer-circle">
        <div id="countdown"></div>
      </div>

      <div class="controls">
        <button id="start-button">Start Focus</button>
        <button id="stop-button" disabled>Stop</button>
      </div>

      <div id="message" class="shortcut-hint">
        Press <span class="shortcut-key">Space</span> to Start/Stop timer
      </div>
    </div>

    <script>
      let countdownInterval;
      let audioCtx;
      let oscillator;
      const defaultMsg = document.getElementById("message").innerHTML;
      const startButton = document.getElementById("start-button");
      const stopButton = document.getElementById("stop-button");
      const countdownMinutesInput = document.getElementById("countdown-minutes");
      const countdownSecondsInput = document.getElementById("countdown-seconds");
      const quickButtons = document.querySelectorAll(".quick-btn");

      startButton.addEventListener("click", startCountdown);
      stopButton.addEventListener("click", stopTimer);

      function handleFocus() {
        const defaultMinutes = countdownMinutesInput.dataset.default;
        const defaultSeconds = countdownSecondsInput.dataset.default;
        if (countdownMinutesInput.value === defaultMinutes && countdownSecondsInput.value === defaultSeconds) {
          countdownMinutesInput.value = "";
          countdownSecondsInput.value = "";
        }
      }

      function handleInput() {
        if (!startButton.disabled) {
          const minutes = Number.parseFloat(countdownMinutesInput.value) || 0;
          const minutesInt = Math.floor(minutes);
          const seconds = Number.parseFloat(countdownSecondsInput.value) || 0;
          const secondsInt = Math.floor(seconds);
          document.getElementById("countdown").innerHTML = `${minutesInt
            .toString()
            .padStart(2, "0")}:${secondsInt.toString().padStart(2, "0")}`;
        }
      }

      countdownMinutesInput.addEventListener("focus", handleFocus);
      countdownSecondsInput.addEventListener("focus", handleFocus);
      countdownMinutesInput.addEventListener("input", handleInput);
      countdownSecondsInput.addEventListener("input", handleInput);

      quickButtons.forEach((btn) => {
        btn.addEventListener("click", function () {
          const minutes = this.dataset.minutes;
          const seconds = this.dataset.seconds;
          countdownMinutesInput.value = minutes;
          countdownSecondsInput.value = seconds;
          countdownMinutesInput.dispatchEvent(new Event("input"));
        });
      });

      // 触发一次输入事件来显示默认值
      countdownMinutesInput.dispatchEvent(new Event("input"));

      document.addEventListener("keydown", function (event) {
        if (event.code === "Space") {
          event.preventDefault();
          if (startButton.disabled) {
            stopTimer();
          } else {
            startCountdown();
          }
        }
      });

      function startCountdown() {
        const minutes = Number.parseInt(countdownMinutesInput.value) || 0;
        const seconds = Number.parseInt(countdownSecondsInput.value) || 0;
        const countdownTime = minutes * 60 + seconds;

        if (countdownTime <= 0) {
          document.getElementById("message").innerHTML =
            "Please enter a countdown time.";
          return;
        }

        let remainingText;
        const startTime = Date.now();
        const endTime = startTime + countdownTime * 1000;

        startButton.disabled = true;
        stopButton.disabled = false;

        updateDisplay();
        countdownInterval = setInterval(updateDisplay, 1000);

        function updateDisplay() {
          const currentTime = Date.now();
          const remainingTime = Math.ceil((endTime - currentTime) / 1000);

          if (remainingTime <= 0) {
            clearInterval(countdownInterval);
            remainingText = "Time's up!";
            playSound();
            showNotification("Time's up!");
          } else {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            remainingText = `${minutes.toString().padStart(2, "0")}:${seconds
              .toString()
              .padStart(2, "0")}`;
          }
          document.title = remainingText;
          document.getElementById("countdown").innerHTML = remainingText;
          document.getElementById("message").innerHTML = defaultMsg;
        }
      }

      function playSound() {
        if (audioCtx) {
          audioCtx.close();
        }
        audioCtx = new (globalThis.AudioContext || globalThis.webkitAudioContext)();
        const notes = [
          { frequency: 523.25, duration: 0.1 }, // C5
          { frequency: 659.25, duration: 0.1 }, // E5
          { frequency: 783.99, duration: 0.2 }, // G5
          { frequency: 1046.5, duration: 0.3 }, // C6
        ];

        let startTime = audioCtx.currentTime;
        let totalDuration = notes.reduce((sum, note) => sum + note.duration, 0);
        const loopInterval = 3;

        function playNotes() {
          if (!audioCtx) {
            return;
          }

          for (const note of notes) {
            oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.type = "sine";
            oscillator.frequency.setValueAtTime(note.frequency, startTime);

            gainNode.gain.setValueAtTime(0, startTime);
            gainNode.gain.linearRampToValueAtTime(0.5, startTime + 0.01);
            gainNode.gain.linearRampToValueAtTime(0, startTime + note.duration);

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.start(startTime);
            oscillator.stop(startTime + note.duration);

            startTime += note.duration;
          }

          // 循环播放（加入间隔时间）
          startTime = audioCtx.currentTime + totalDuration + loopInterval;
          if (!stopButton.disabled && audioCtx) {
            // 添加 audioCtx 检查
            setTimeout(playNotes, (totalDuration + loopInterval) * 1000);
          }
        }

        playNotes();
      }

      function stopSound() {
        if (audioCtx) {
          audioCtx.close();
          audioCtx = null;
        }
      }

      function stopTimer() {
        clearInterval(countdownInterval);
        document.title = "Timer";
        document.getElementById("countdown").innerHTML = "";
        document.getElementById("message").innerHTML = defaultMsg;
        stopSound();
        startButton.disabled = false;
        stopButton.disabled = true;
        // 重新显示输入框的值
        countdownMinutesInput.dispatchEvent(new Event("input"));
      }

      function showNotification(text) {
        if (!("Notification" in globalThis)) {
          alert("This browser does not support desktop notification");
        } else if (Notification.permission === "granted") {
          new Notification(text);
        } else if (Notification.permission !== "denied") {
          Notification.requestPermission().then(function (permission) {
            if (permission === "granted") {
              new Notification(text);
            }
          });
        }
      }
    </script>
  </body>
</html>
